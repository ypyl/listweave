<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ListWeave</title>
    <link rel="stylesheet" href="src/styles.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="lw-elm.js"></script>
    <script>
      console.log("Initializing Elm app...");
      var app = Elm.Main.init({ node: document.getElementById("root") });
      console.log("Elm app initialized.");

      function getCaretCoordinates() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          return {
            top: rect.bottom,
            left: rect.left,
            width: rect.width,
          };
        }
        return { top: 0, left: 0, width: 0 };
      }

      app.ports.setCaret.subscribe(function (data) {
        const id = data.id;
        const pos = data.pos;
        const input = document.getElementById("input-id-" + id);
        if (input) {
          input.focus();
          const range = document.createRange();
          const sel = window.getSelection();
          let offset = pos;
          for (const node of input.childNodes) {
            if (node.nodeType === Node.TEXT_NODE) {
              const len = node.length;
              if (offset <= len) {
                range.setStart(node, offset);
                break;
              }
              offset -= len;
            } else if (node.nodeName === "BR") {
              if (offset === 0) {
                range.setStartBefore(node);
                break;
              }
              offset -= 1;
            }
          }
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });

      app.ports.initEditable.subscribe(function (id) {
        const input = document.getElementById("input-id-" + id);
        if (input) {
          input.addEventListener("input", function (event) {
            const sel = window.getSelection();
            let cursorPos = 0;
            if (sel.rangeCount > 0) {
              const range = sel.getRangeAt(0);
              cursorPos = range.startOffset;
            }
            app.ports.editableInput.send({
              id: id,
              content: event.target.innerText,
              cursorPos: cursorPos,
            });
          });
        }
      });

      app.ports.requestCursorPosition.subscribe(function (id) {
        const coords = getCaretCoordinates();
        if (app.ports && app.ports.receiveCursorPosition) {
          app.ports.receiveCursorPosition.send({
            top: Math.ceil(coords.top),
            left: Math.ceil(coords.left),
            width: Math.ceil(coords.width),
          });
        }
      });

      app.ports.getSearchInputPosition.subscribe(function () {
        const searchInput = document.getElementById("search-input");
        if (!searchInput) {
          return;
        }

        const rect = searchInput.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

        if (app.ports && app.ports.receiveCursorPosition) {
          app.ports.receiveCursorPosition.send({
            top: Math.ceil(rect.bottom + scrollTop + 2),
            left: Math.ceil(rect.left + scrollLeft),
            width: Math.ceil(rect.width),
          });
        }
      });

      app.ports.setSearchInputCursor.subscribe(function (position) {
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.focus();
          searchInput.setSelectionRange(position, position);
        }
      });

      app.ports.getCurrentCursorPosition.subscribe(function (itemId) {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          const cursorPos = range.startOffset;
          app.ports.receiveCurrentCursorPosition.send({
            itemId: itemId,
            tag: "", // Will be handled by Elm
            cursorPos: cursorPos,
          });
        }
      });

      app.ports.getPosition.subscribe(function (data) {
        // data: { id: number, clientX: number, clientY: number }
        const viewItemId = data.id;
        const clientX = data.clientX;
        const clientY = data.clientY;

        const viewItem = document.getElementById("view-item-" + viewItemId);
        if (!viewItem) {
          return;
        }

        const contentDiv = viewItem.querySelector(".content-click-area");
        if (!contentDiv) {
          return;
        }

        const clickRange = document.caretRangeFromPoint
          ? document.caretRangeFromPoint(clientX, clientY)
          : document.caretPositionFromPoint?.(clientX, clientY);

        if (!clickRange || !contentDiv.contains(clickRange.startContainer)) {
          return;
        }

        const totalRange = document.createRange();
        totalRange.selectNodeContents(contentDiv);
        totalRange.setEnd(clickRange.startContainer, clickRange.startOffset);
        const offset = totalRange.toString().length;

        if (app.ports.clickedAt) {
          app.ports.clickedAt.send({ id: viewItemId, pos: offset });
        }
      });


      app.ports.downloadJson.subscribe(function (data) {
        const blob = new Blob([data.content], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = data.filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
      });

      app.ports.readFile.subscribe(function () {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (event) {
            try {
              const json = JSON.parse(event.target.result);
              app.ports.receiveFile.send(json);
            } catch (err) {
              console.error("Failed to parse JSON file", err);
              // Optionally send an error message back to Elm
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });
    </script>
  </body>
</html>
